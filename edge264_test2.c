#include <dirent.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#ifdef _WIN32
	#include <windows.h>
	#include <psapi.h>
	#define dlsym (void*)GetProcAddress
	#define dlclose FreeLibrary
#else
	#include <dlfcn.h>
	#include <fcntl.h>
	#include <sys/mman.h>
	#include <sys/resource.h>
	#include <sys/stat.h>
	#include <sys/types.h>
	#include <unistd.h>
#endif
#include "edge264.h"
#include "edge264_internal.h"
#include "edge264_intra.c"
#include "edge264_inter.c"



/**
 * Static variables and helper functions
 */
#define RESET  "\e[0m"
#define BOLD   "\e[1m"
#define RED    "\e[31m"
#define GREEN  "\e[32m"
#define YELLOW "\e[33m"
#define BLUE   "\e[34m"

static Edge264Decoder *dec;
static int count_pass;
static int count_frames;
static void (*log_tester)(const char *);

static int flt(const struct dirent *a) {
	char *ext = strrchr(a->d_name, '.');
	return ext != NULL && strcmp(ext, ".264") == 0;
}
static int cmp(const struct dirent **a, const struct dirent **b) {
	return -strcasecmp((*a)->d_name, (*b)->d_name);
}
static const char *errno_str(int e) {
	switch (e) {
		case 0: return "0";
		case ENOTSUP: return "ENOTSUP";
		case EBADMSG: return "EBADMSG";
		case EINVAL: return "EINVAL";
		case ENODATA: return "ENODATA";
		case ENOMEM: return "ENOMEM";
		case ENOBUFS: return "ENOBUFS";
		case EWOULDBLOCK: return "EWOULDBLOCK";
		case ENOMSG: return "ENOMSG";
		default: return "UNKNOWN";
	}
}



#define ERROR(msg, ...) { printf(msg, ##__VA_ARGS__); perror(NULL); exit(1); }
#define ASSERT(cond, msg, ...) { if (cond) { printf(RED msg RESET, ##__VA_ARGS__); exit(1); } }
static void log_callback(const char *str, void *_) { if (log_tester) log_tester(str); }
static void print_logger(const char *str) { fputs(str, stdout); }
static void max_logs_logger(const char *str) {
	ASSERT(strlen(str) + 1 != sizeof(dec->log_buf),
		"max-logs: log length (%zd) differs from log_buf size (%zu)\n",
		strlen(str) + 1, sizeof(dec->log_buf));
}
static void finish_frame_post() {
	ASSERT(count_frames != 12,
		"finish-frame: number of decoded frames (%d) differs from expected (12)\n",
		count_frames);
}

static int assert_block(const char *name, const uint8_t *p, size_t pstride, const uint8_t *q, int w, int h) {
	int pass = 1;
	for (int y = 0; y < h; y++)
		pass &= memcmp(p + pstride * y, q + w * y, w) == 0;
	if (!pass) {
		printf("%s: block differs from expected\n", name);
		for (int y = 0; y < h; y++) {
			for (int x = 0; x < w; x++)
				printf(p[x + y * pstride] == q[x + y * w] ? " %3d" : RED " %3d" RESET, p[x + y * pstride]);
			putchar('\t');
			for (int x = 0; x < w; x++)
				printf(" %3d", q[x + y * w]);
			putchar('\n');
		}
		exit(1);
	}
}



static void parse_NALs(const char *name, const uint8_t *nal, const uint8_t *end, void (*post_test)(), const int8_t *expect) {
	nal += 3 + (nal[2] == 0); // skip the [0]001 delimiter
	Edge264Frame out;
	int res = 0;
	count_frames = 0;
	for (int i = 0; res != ENODATA; i++) {
		res = edge264_decode_NAL(dec, nal, end, 0, NULL, NULL, &nal);
		if (res != expect[i])
			ERROR(RED "%s: NAL at index %d returned %s where %s was expected\n" RESET, name, i, errno_str(res), errno_str(expect[i]));
		while (!edge264_get_frame(dec, &out, 0))
			count_frames += 1;
	}
	if (post_test)
		post_test();
	edge264_flush(dec);
}



static void test_page_boundaries() {
	printf("\e[A\e[K%d " GREEN "PASS" RESET " (page-boundaries)\n", count_pass);
	log_tester = NULL;
	long pagesize = sysconf(_SC_PAGESIZE);
	uint8_t *page = mmap(0, pagesize * 3, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) + pagesize;
	
	// CPB boundaries
	FILE *f = fopen("tests/page-boundaries.264", "r");
	if (!f)
		ERROR("Cannot open file tests/page-boundaries.264");
	fseek(f, 0L, SEEK_END);
	long filesize = ftell(f);
	rewind(f);
	mprotect(page, pagesize, PROT_WRITE);
	fread(page, filesize, 1, f);
	rewind(f);
	fread(page + pagesize - filesize, filesize, 1, f);
	mprotect(page, pagesize, PROT_READ);
	edge264_find_start_code(page, page + filesize, 1);
	parse_NALs("page-boundaries", page, page + filesize, NULL, (int8_t[]){0, ENODATA});
	parse_NALs("page-boundaries", page + pagesize - filesize, page + pagesize, NULL, (int8_t[]){0, ENODATA});
	fclose(f);
	
	// Intra boundaries
	mprotect(page, pagesize, PROT_READ | PROT_WRITE);
	static const int8_t offI4x4[I4x4_HU_8 + 1] = {16, 4, 20, 16, 4, 0, 16, 16, 24, 24, 24, 16, 16, 4};
	for (int i = 0; i <= I4x4_HU_8; i++)
		decode_intra4x4(page + offI4x4[i], 16, i, (i16x8){});
	static const int8_t offI8x8[I8x8_HU_D_8 + 1] = {24, 24, 16, 16, 24, 8, 24, 24, 24, 16, 16, 24, 8, 24, 16, 16, 0, 24, 24, 16, 16, 24, 24, 24, 24, 24, 24, 24, 16, 16, 24, 8};
	for (int i = 0; i <= I8x8_HU_D_8; i++)
		decode_intra8x8(page + offI8x8[i], 16, i, (i16x8){});
	static const int8_t offI16x16[I16x16_P_8 + 1] = {16, 16, 16, 16, 16, 0, 32};
	for (int i = 0; i <= I16x16_P_8; i++)
		decode_intra16x16(page + offI16x16[i], 16, i, (i16x8){});
	static const int8_t offIC8x8[IC8x8_P_8 + 1] = {16, 16, 8, 0, 8, 16, 24};
	for (int i = 0; i <= IC8x8_P_8; i++)
		decode_intraChroma(page + offIC8x8[i], 8, i, (i16x8){});
	
	// Inter boundaries
	static const int8_t offInterLo[16] = {0, 2, 2, 2, 64, 66, 66, 66, 64, 66, 66, 66, 64, 66, 66, 66};
	static const int8_t offInterHi[48] = {28, 18, 18, 18, -68, -78, -78, -78, -68, -78, -78, -78, -68, -78, -78, -78, 24, 18, 18, 18, -72, -78, -78, -78, -72, -78, -78, -78, -72, -78, -78, -78, 16, 10, 10, 10, -80, -86, -86, -86, -80, -86, -86, -86, -80, -86, -86, -86};
	static const int8_t offInterHiC[3] = {-36, -40, -48};
	for (int h = 0; h < 3; h++) {
		for (int i = 0; i < 48; i++) {
			decode_inter_luma(i, 4 << h, 32, page + offInterLo[i & 15], 32, page, (i8x16){});
			decode_inter_luma(i, 4 << h, 32, page + pagesize + offInterHi[i] - (4 << h) * 32, 32, page + pagesize - (4 << (i >> 4)) - ((4 << h) - 1) * 32, (i8x16){});
		}
		for (int w = 0; w < 3; w++) {
			decode_inter_chroma(4 << w, 4 << h, 32, page, 32, page, (i8x16){}, (i8x16){});
			decode_inter_chroma(4 << w, 4 << h, 32, page + pagesize + offInterHiC[w] - (4 << h) * 32, 32, page + pagesize - (4 << w) - ((4 << h) - 1) * 32, (i8x16){}, (i8x16){});
		}
	}
	munmap(page - pagesize, pagesize * 3);
	count_pass += 1;
}



static void test_intra_decoding() {
	printf("\e[A\e[K%d " GREEN "PASS" RESET " (intra-decoding)\n", count_pass);
	
	// setup border values
	uint8_t *p = malloc(32 * 18) + 80;
	for (int x = -1; x < 16; x++) {
		p[x - 32] = 194 + x * 4;
		p[x - 64] = 198 + x * 4;
	}
	for (int y = 0; y < 16; y++)
		p[y * 32 - 1] = 186 - y * 4;
	
	// execute Intra4x4 modes and compare to expected block values
	i16x8 clip = {255, 255, 255, 255, 255, 255, 255, 255};
	static const char *I4x4_names[] = {"I4x4_V_8", "I4x4_H_8", "I4x4_DC_8", "I4x4_DC_A_8", "I4x4_DC_B_8", "I4x4_DC_AB_8", "I4x4_DDL_8", "I4x4_DDL_C_8", "I4x4_DDR_8", "I4x4_VR_8", "I4x4_HD_8", "I4x4_VL_8", "I4x4_VL_C_8", "I4x4_HU_8"};
	static const uint8_t I4x4_expect[][16] = {
		{194, 198, 202, 206, 194, 198, 202, 206, 194, 198, 202, 206, 194, 198, 202, 206},
		{186, 186, 186, 186, 182, 182, 182, 182, 178, 178, 178, 178, 174, 174, 174, 174},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200},
		{180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180},
		{128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128},
		{198, 202, 206, 210, 202, 206, 210, 214, 206, 210, 214, 218, 210, 214, 218, 221},
		{198, 202, 205, 206, 202, 205, 206, 206, 205, 206, 206, 206, 206, 206, 206, 206},
		{190, 194, 198, 202, 186, 190, 194, 198, 182, 186, 190, 194, 178, 182, 186, 190},
		{192, 196, 200, 204, 190, 194, 198, 202, 186, 192, 196, 200, 182, 190, 194, 198},
		{188, 190, 194, 198, 184, 186, 188, 190, 180, 182, 184, 186, 176, 178, 180, 182},
		{196, 200, 204, 208, 198, 202, 206, 210, 200, 204, 208, 212, 202, 206, 210, 214},
		{196, 200, 204, 206, 198, 202, 205, 206, 200, 204, 206, 206, 202, 205, 206, 206},
		{184, 182, 180, 178, 180, 178, 176, 175, 176, 175, 174, 174, 174, 174, 174, 174},
	};
	for (int mode = 0; mode <= I4x4_HU_8; mode++) {
		decode_intra4x4(p, 32, mode, clip);
		assert_block(I4x4_names[mode], p, 32, I4x4_expect[mode], 4, 4);
	}
	
	// execute Intra8x8 modes and compare to expected block values
	static const char *I8x8_names[] = {"I8x8_V_8", "I8x8_V_C_8", "I8x8_V_D_8", "I8x8_V_CD_8", "I8x8_H_8", "I8x8_H_D_8", "I8x8_DC_8", "I8x8_DC_A_8", "I8x8_DC_AC_8", "I8x8_DC_AD_8", "I8x8_DC_ACD_8", "I8x8_DC_B_8", "I8x8_DC_BD_8", "I8x8_DC_C_8", "I8x8_DC_D_8", "I8x8_DC_CD_8", "I8x8_DC_AB_8", "I8x8_DDL_8", "I8x8_DDL_C_8", "I8x8_DDL_D_8", "I8x8_DDL_CD_8", "I8x8_DDR_8", "I8x8_DDR_C_8", "I8x8_VR_8", "I8x8_VR_C_8", "I8x8_HD_8", "I8x8_VL_8", "I8x8_VL_C_8", "I8x8_VL_D_8", "I8x8_VL_CD_8", "I8x8_HU_8", "I8x8_HU_D_8"};
	static const uint8_t I8x8_expect[][64] = {
		{194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222, 194, 198, 202, 206, 210, 214, 218, 222},
		{194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221, 194, 198, 202, 206, 210, 214, 218, 221},
		{195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222, 195, 198, 202, 206, 210, 214, 218, 222},
		{195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221, 195, 198, 202, 206, 210, 214, 218, 221},
		{186, 186, 186, 186, 186, 186, 186, 186, 182, 182, 182, 182, 182, 182, 182, 182, 178, 178, 178, 178, 178, 178, 178, 178, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 166, 166, 166, 166, 166, 166, 166, 166, 162, 162, 162, 162, 162, 162, 162, 162, 159, 159, 159, 159, 159, 159, 159, 159},
		{185, 185, 185, 185, 185, 185, 185, 185, 182, 182, 182, 182, 182, 182, 182, 182, 178, 178, 178, 178, 178, 178, 178, 178, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 166, 166, 166, 166, 166, 166, 166, 166, 162, 162, 162, 162, 162, 162, 162, 162, 159, 159, 159, 159, 159, 159, 159, 159},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208},
		{208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208},
		{208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208},
		{208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208},
		{172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172},
		{172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128},
		{198, 202, 206, 210, 214, 218, 222, 226, 202, 206, 210, 214, 218, 222, 226, 230, 206, 210, 214, 218, 222, 226, 230, 234, 210, 214, 218, 222, 226, 230, 234, 238, 214, 218, 222, 226, 230, 234, 238, 242, 218, 222, 226, 230, 234, 238, 242, 246, 222, 226, 230, 234, 238, 242, 246, 250, 226, 230, 234, 238, 242, 246, 250, 252},
		{198, 202, 206, 210, 214, 218, 221, 222, 202, 206, 210, 214, 218, 221, 222, 222, 206, 210, 214, 218, 221, 222, 222, 222, 210, 214, 218, 221, 222, 222, 222, 222, 214, 218, 221, 222, 222, 222, 222, 222, 218, 221, 222, 222, 222, 222, 222, 222, 221, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222},
		{198, 202, 206, 210, 214, 218, 222, 226, 202, 206, 210, 214, 218, 222, 226, 230, 206, 210, 214, 218, 222, 226, 230, 234, 210, 214, 218, 222, 226, 230, 234, 238, 214, 218, 222, 226, 230, 234, 238, 242, 218, 222, 226, 230, 234, 238, 242, 246, 222, 226, 230, 234, 238, 242, 246, 250, 226, 230, 234, 238, 242, 246, 250, 252},
		{198, 202, 206, 210, 214, 218, 221, 222, 202, 206, 210, 214, 218, 221, 222, 222, 206, 210, 214, 218, 221, 222, 222, 222, 210, 214, 218, 221, 222, 222, 222, 222, 214, 218, 221, 222, 222, 222, 222, 222, 218, 221, 222, 222, 222, 222, 222, 222, 221, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222},
		{190, 194, 198, 202, 206, 210, 214, 218, 186, 190, 194, 198, 202, 206, 210, 214, 182, 186, 190, 194, 198, 202, 206, 210, 178, 182, 186, 190, 194, 198, 202, 206, 174, 178, 182, 186, 190, 194, 198, 202, 170, 174, 178, 182, 186, 190, 194, 198, 166, 170, 174, 178, 182, 186, 190, 194, 162, 166, 170, 174, 178, 182, 186, 190},
		{190, 194, 198, 202, 206, 210, 214, 218, 186, 190, 194, 198, 202, 206, 210, 214, 182, 186, 190, 194, 198, 202, 206, 210, 178, 182, 186, 190, 194, 198, 202, 206, 174, 178, 182, 186, 190, 194, 198, 202, 170, 174, 178, 182, 186, 190, 194, 198, 166, 170, 174, 178, 182, 186, 190, 194, 162, 166, 170, 174, 178, 182, 186, 190},
		{192, 196, 200, 204, 208, 212, 216, 220, 190, 194, 198, 202, 206, 210, 214, 218, 186, 192, 196, 200, 204, 208, 212, 216, 182, 190, 194, 198, 202, 206, 210, 214, 178, 186, 192, 196, 200, 204, 208, 212, 174, 182, 190, 194, 198, 202, 206, 210, 170, 178, 186, 192, 196, 200, 204, 208, 166, 174, 182, 190, 194, 198, 202, 206},
		{192, 196, 200, 204, 208, 212, 216, 220, 190, 194, 198, 202, 206, 210, 214, 218, 186, 192, 196, 200, 204, 208, 212, 216, 182, 190, 194, 198, 202, 206, 210, 214, 178, 186, 192, 196, 200, 204, 208, 212, 174, 182, 190, 194, 198, 202, 206, 210, 170, 178, 186, 192, 196, 200, 204, 208, 166, 174, 182, 190, 194, 198, 202, 206},
		{188, 190, 194, 198, 202, 206, 210, 214, 184, 186, 188, 190, 194, 198, 202, 206, 180, 182, 184, 186, 188, 190, 194, 198, 176, 178, 180, 182, 184, 186, 188, 190, 172, 174, 176, 178, 180, 182, 184, 186, 168, 170, 172, 174, 176, 178, 180, 182, 164, 166, 168, 170, 172, 174, 176, 178, 161, 162, 164, 166, 168, 170, 172, 174},
		{196, 200, 204, 208, 212, 216, 220, 224, 198, 202, 206, 210, 214, 218, 222, 226, 200, 204, 208, 212, 216, 220, 224, 228, 202, 206, 210, 214, 218, 222, 226, 230, 204, 208, 212, 216, 220, 224, 228, 232, 206, 210, 214, 218, 222, 226, 230, 234, 208, 212, 216, 220, 224, 228, 232, 236, 210, 214, 218, 222, 226, 230, 234, 238},
		{196, 200, 204, 208, 212, 216, 220, 222, 198, 202, 206, 210, 214, 218, 221, 222, 200, 204, 208, 212, 216, 220, 222, 222, 202, 206, 210, 214, 218, 221, 222, 222, 204, 208, 212, 216, 220, 222, 222, 222, 206, 210, 214, 218, 221, 222, 222, 222, 208, 212, 216, 220, 222, 222, 222, 222, 210, 214, 218, 221, 222, 222, 222, 222},
		{197, 200, 204, 208, 212, 216, 220, 224, 198, 202, 206, 210, 214, 218, 222, 226, 200, 204, 208, 212, 216, 220, 224, 228, 202, 206, 210, 214, 218, 222, 226, 230, 204, 208, 212, 216, 220, 224, 228, 232, 206, 210, 214, 218, 222, 226, 230, 234, 208, 212, 216, 220, 224, 228, 232, 236, 210, 214, 218, 222, 226, 230, 234, 238},
		{197, 200, 204, 208, 212, 216, 220, 222, 198, 202, 206, 210, 214, 218, 221, 222, 200, 204, 208, 212, 216, 220, 222, 222, 202, 206, 210, 214, 218, 221, 222, 222, 204, 208, 212, 216, 220, 222, 222, 222, 206, 210, 214, 218, 221, 222, 222, 222, 208, 212, 216, 220, 222, 222, 222, 222, 210, 214, 218, 221, 222, 222, 222, 222},
		{184, 182, 180, 178, 176, 174, 172, 170, 180, 178, 176, 174, 172, 170, 168, 166, 176, 174, 172, 170, 168, 166, 164, 162, 172, 170, 168, 166, 164, 162, 161, 160, 168, 166, 164, 162, 161, 160, 159, 159, 164, 162, 161, 160, 159, 159, 159, 159, 161, 160, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159},
	};
	for (int mode = 0; mode <= I8x8_HU_8; mode++) {
		decode_intra8x8(p, 32, mode, clip);
		assert_block(I8x8_names[mode], p, 32, I8x8_expect[mode], 8, 8);
	}
	
	// execute Intra16x16 modes and compare to expected block values
	static const char *I16x16_names[] = {"I16x16_V_8", "I16x16_H_8", "I16x16_DC_8", "I16x16_DC_A_8", "I16x16_DC_B_8", "I16x16_DC_AB_8", "I16x16_P_8"};
	static const uint8_t I16x16_expect[][256] = {
		{194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 254},
		{186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126},
		{190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190},
		{224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224},
		{156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156},
		{128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128},
		{190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 250, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 246, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 242, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 238, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 234, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 230, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 226, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 222, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 218, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 214, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 210, 146, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 206, 142, 146, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 202, 138, 142, 146, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 198, 134, 138, 142, 146, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190, 194, 130, 134, 138, 142, 146, 150, 154, 158, 162, 166, 170, 174, 178, 182, 186, 190},
	};
	for (int mode = 0; mode <= I16x16_P_8; mode++) {
		decode_intra16x16(p, 32, mode, clip);
		assert_block(I16x16_names[mode], p, 32, I16x16_expect[mode], 16, 16);
	}
	
	// execute IntraChroma modes and compare to expected block values
	static const char *IC8x8_names[] = {"IC8x8_DC_8", "IC8x8_DC_A_8", "IC8x8_DC_B_8", "IC8x8_DC_AB_8", "IC8x8_H_8", "IC8x8_V_8", "IC8x8_P_8"};
	static const uint8_t IC8x8_expect[][128] = {
		{189, 189, 189, 189, 220, 220, 220, 220, 185, 185, 185, 185, 216, 216, 216, 216, 189, 189, 189, 189, 220, 220, 220, 220, 185, 185, 185, 185, 216, 216, 216, 216, 189, 189, 189, 189, 220, 220, 220, 220, 185, 185, 185, 185, 216, 216, 216, 216, 189, 189, 189, 189, 220, 220, 220, 220, 185, 185, 185, 185, 216, 216, 216, 216, 142, 142, 142, 142, 181, 181, 181, 181, 138, 138, 138, 138, 177, 177, 177, 177, 142, 142, 142, 142, 181, 181, 181, 181, 138, 138, 138, 138, 177, 177, 177, 177, 142, 142, 142, 142, 181, 181, 181, 181, 138, 138, 138, 138, 177, 177, 177, 177, 142, 142, 142, 142, 181, 181, 181, 181, 138, 138, 138, 138, 177, 177, 177, 177},
		{204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216, 204, 204, 204, 204, 220, 220, 220, 220, 200, 200, 200, 200, 216, 216, 216, 216},
		{174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138},
		{128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128},
		{186, 186, 186, 186, 186, 186, 186, 186, 182, 182, 182, 182, 182, 182, 182, 182, 178, 178, 178, 178, 178, 178, 178, 178, 174, 174, 174, 174, 174, 174, 174, 174, 170, 170, 170, 170, 170, 170, 170, 170, 166, 166, 166, 166, 166, 166, 166, 166, 162, 162, 162, 162, 162, 162, 162, 162, 158, 158, 158, 158, 158, 158, 158, 158, 154, 154, 154, 154, 154, 154, 154, 154, 150, 150, 150, 150, 150, 150, 150, 150, 146, 146, 146, 146, 146, 146, 146, 146, 142, 142, 142, 142, 142, 142, 142, 142, 138, 138, 138, 138, 138, 138, 138, 138, 134, 134, 134, 134, 134, 134, 134, 134, 130, 130, 130, 130, 130, 130, 130, 130, 126, 126, 126, 126, 126, 126, 126, 126},
		{198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222, 198, 202, 206, 210, 214, 218, 222, 226, 194, 198, 202, 206, 210, 214, 218, 222},
		{190, 194, 198, 202, 206, 210, 214, 218, 186, 190, 194, 198, 202, 206, 210, 214, 182, 186, 190, 194, 198, 202, 206, 210, 178, 182, 186, 190, 194, 198, 202, 206, 174, 178, 182, 186, 190, 194, 198, 202, 170, 174, 178, 182, 186, 190, 194, 198, 166, 170, 174, 178, 182, 186, 190, 194, 162, 166, 170, 174, 178, 182, 186, 190, 158, 162, 166, 170, 174, 178, 182, 186, 154, 158, 162, 166, 170, 174, 178, 182, 150, 154, 158, 162, 166, 170, 174, 178, 146, 150, 154, 158, 162, 166, 170, 174, 142, 146, 150, 154, 158, 162, 166, 170, 138, 142, 146, 150, 154, 158, 162, 166, 134, 138, 142, 146, 150, 154, 158, 162, 130, 134, 138, 142, 146, 150, 154, 158},
	};
	for (int mode = 0; mode <= IC8x8_P_8; mode++) {
		decode_intraChroma(p, 32, mode, clip);
		assert_block(IC8x8_names[mode], p, 32, IC8x8_expect[mode], 8, 16);
	}
	free(p - 80);
	count_pass += 1;
}



static void test(const char *name, void (*log_test)(const char *), void (*post_test)(), const int8_t *expect) {
	log_tester = log_test;
	printf("\e[A\e[K%d " GREEN "PASS" RESET " (%s)\n", count_pass, name);
	
	// open and memory map the input test file
	char file_name[strlen(name) + 11];
	snprintf(file_name, sizeof(file_name), "tests/%s.264", name);
	#ifdef _WIN32
		HANDLE f = NULL, m = NULL;
		void *v = NULL;
		if ((f = CreateFileA(file_name, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL)) == INVALID_HANDLE_VALUE ||
			(m = CreateFileMappingA(f, NULL, PAGE_READONLY, 0, 0, NULL)) == NULL ||
			(v = MapViewOfFile(m, FILE_MAP_READ, 0, 0, 0)) == NULL)
			ERROR("Error opening file %s for input: %lu\n", file_name, GetLastError());
		const uint8_t *nal = v;
		const uint8_t *end = v + GetFileSize(f, NULL);
	#else
		int fd = -1;
		struct stat st;
		uint8_t *mm = MAP_FAILED;
		if ((fd = open(file_name, O_RDONLY)) < 0 || fstat(fd, &st) < 0 ||
			(mm = mmap(NULL, st.st_size, PROT_READ, MAP_SHARED, fd, 0)) == MAP_FAILED)
			ERROR("Error opening file %s for input: ", file_name);
		const uint8_t *nal = mm;
		const uint8_t *end = mm + st.st_size;
	#endif
	
	parse_NALs(name, nal, end, post_test, expect);
	
	// close everything
	#ifdef _WIN32
		UnmapViewOfFile(v);
		CloseHandle(m);
		CloseHandle(f);
	#else
		munmap(mm, st.st_size);
		close(fd);
	#endif
	count_pass += 1;
}



int main(int argc, char *argv[]) {
	// read command-line options
	int help = 0;
	int compare_yuv = 1;
	for (int i = 1; i < argc; i++) {
		if (argv[i][0] != '-') {
			help = 1;
		} else for (int j = 1; argv[i][j]; j++) {
			switch (argv[i][j]) {
				case 'y': compare_yuv = 0; break;
				default: help = 1; break;
			}
		}
	}
	
	// print help and exit if requested
	if (help) {
		printf("Usage: " BOLD "%s [-hsy]" RESET "\n"
			"Runs all conformance tests, expecting a 'conformance' directory containing .264\n"
			"files along with their expected .yuv results (and .1.yuv for MVC)\n"
			"-h\tprint this help and exit\n"
			"-y\tdisable comparison against YUV pairs\n"
			, argv[0]);
		return 0;
	}
	
	// run all stress tests
	putchar('\n');
	dec = edge264_alloc(0, log_callback, NULL, 0, NULL, NULL, NULL);
	test("supp-nals", NULL, NULL, (int8_t[]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ENOBUFS, 0, 0, ENODATA});
	test("unsupp-nals", NULL, NULL, (int8_t[]){ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENODATA});
	test("supp-nals", NULL, NULL, (int8_t[]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ENOBUFS, 0, 0, ENODATA});
	test("unsupp-nals", NULL, NULL, (int8_t[]){ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENOTSUP, ENODATA});
	test("max-logs", max_logs_logger, NULL, (int8_t[]){0, ENODATA});
	test("finish-frame", NULL, finish_frame_post, (int8_t[]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ENOBUFS, ENODATA});
	test("nal-ref-idc-0", NULL, NULL, (int8_t[]){0, 0, 0, 0, 0, 0, 0, 0, ENOBUFS, 0, 0, ENODATA});
	test("no-trailing-bit", NULL, NULL, (int8_t[]){0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ENOBUFS, 0, 0, ENODATA});
	test_page_boundaries();
	test_intra_decoding();
	printf("\e[A\e[K%d " GREEN "PASS" RESET "\n", count_pass);
	
	// clear all open stuff
	edge264_free(&dec);
	return 0;
}
